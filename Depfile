#Config
Artifact=kernel
TempDir=obj
SourceDir=asm src
AdditionalObjects=obj/main.o
ExternalObjects=conductance/|*.o

LexUseCpp
YaccUseCpp

# Tools
AS=gcc
CC=gcc
CXX=g++
LD=g++
LEX=flex
YACC=bison
#TEMPLE=mono /home/felix/projects/temple/bin/Debug/temple.exe

# Flags
FLAGS=-m32 -DCIRCUIT_OS -Dnullptr=0 -D__cdecl="__attribute__((cdecl))" -mno-sse -mno-sse2 -mno-mmx -I/home/felix/projects/Electronics/Electronics/Conductance -I/home/felix/projects/Electronics/Electronics/Tools
ASFLAGS=-masm=intel
CCFLAGS=-g -std=c11 -Dnullptr=0 -Wall -g -fno-stack-protector -ffreestanding -Iinclude
CXXFLAGS=-g -std=c++11 -Wall -g -fno-stack-protector -fno-use-cxa-atexit -nostdlib -fno-builtin -fno-rtti -fno-exceptions -fno-leading-underscore -Wall -Wextra -ffreestanding -Wno-unused-function -Iinclude
LDFLAGS=-g -m32 -nostdlib -fno-builtin -Tkernel.ld

--

obj/main.o: scripts/main.spark
	/home/felix/projects/Electronics/build-Electronics-Desktop-Debug/bin/spark \
		scripts/main.spark \
		obj/main.ca
	objcopy -B i386 -I binary -O elf32-i386 \
		obj/main.ca obj/main.o
	objcopy  \
		--redefine-sym _binary_obj_main_ca_start=mainscript_start \
		--redefine-sym _binary_obj_main_ca_end=mainscript_end \
		--redefine-sym _binary_obj_main_ca_size=mainscript_size \
		obj/main.o

.PHONY: run
run:
	qemu-system-i386 -serial stdio -kernel kernel

.PHONY: debug
debug:
	qemu-system-i386 -s -S -serial stdio -kernel kernel
